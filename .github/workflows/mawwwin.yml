name: Professional RDP Deployment - Ultimate Fix v2.1

on:
  workflow_dispatch:

jobs:
  deployment:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      aa2: "XCDOOD"
      aa3: "Zxxz4444" 
      APP_BUNDLE_URL: "https://tinyurl.com/appk5214s"
      KEY_CHOICE: "2" 
      PYTHONIOENCODING: "utf-8"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. إعداد النظام والمستخدمين
      - name: System & RDP Setup
        shell: pwsh
        run: |
          Write-Host "==== 1. CONFIGURING RDP & USERS ===="
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
          $Pass = $env:aa3
          $Secure = ConvertTo-SecureString $Pass -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Secure
          if (-not (Get-LocalUser -Name $env:aa2 -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $env:aa2 -Password $Secure -AccountNeverExpires
              Add-LocalGroupMember Administrators $env:aa2
          }

      # 2. تحميل الحزمة الأساسية
      - name: Download & Extract App Bundle
        shell: pwsh
        run: |
          $TempDir = Join-Path $env:TEMP 'AppBundle'
          New-Item -Path $TempDir -ItemType Directory -Force | Out-Null
          $BundleZip = Join-Path $TempDir 'app_bundle.zip'
          Invoke-WebRequest -Uri $env:APP_BUNDLE_URL -OutFile $BundleZip -UseBasicParsing
          Expand-Archive -Path $BundleZip -DestinationPath $TempDir -Force

      # 3. إعداد RustDesk
      - name: RustDesk Configuration
        shell: python
        run: |
          import subprocess, os, time
          bundle_dir = os.path.join(os.environ['TEMP'], 'AppBundle')
          rust_installer = next((os.path.join(root, f) for root, _, files in os.walk(bundle_dir) for f in files if "rust" in f.lower() and f.endswith(".exe")), None)
          if rust_installer:
              subprocess.run([rust_installer, "--silent-install"], check=True)
              time.sleep(15)
              rust_exe = r"C:\Program Files\RustDesk\rustdesk.exe"
              subprocess.run([rust_exe, "--password", os.environ['aa3']], check=True)
              time.sleep(5)
              result = subprocess.run([rust_exe, "--get-id"], capture_output=True, text=True, check=True)
              print(f"\nRUSTDESK ID: {result.stdout.strip()}\n")

      # 4. إعداد Tailscale
      - name: Tailscale Setup
        shell: pwsh
        run: |
          $ExtractDir = Join-Path $env:TEMP 'AppBundle'
          $TsInstaller = Get-ChildItem -Path $ExtractDir -Filter "*tailscale*.msi" -Recurse | Select-Object -First 1
          Start-Process msiexec.exe -ArgumentList '/i', $TsInstaller.FullName, '/quiet', '/norestart' -Wait
          $KeyFile = Get-ChildItem -Path $ExtractDir -Filter "key$($env:KEY_CHOICE).txt" -Recurse | Select-Object -First 1
          $Encoded = (Get-Content $KeyFile.FullName -Raw).Trim()
          $RealKey = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($Encoded)).Trim()
          $TsExe = Join-Path $env:ProgramFiles 'Tailscale\tailscale.exe'
          Start-Process -FilePath $TsExe -ArgumentList "up --authkey=$RealKey --hostname=RDP-Professional" -Wait

      # 5. استخراج ملفات الديسك توب
      - name: Deploy Desktop Files
        shell: pwsh
        run: |
          $ExtractDir = Join-Path $env:TEMP 'AppBundle'
          $LinkFile = Get-ChildItem -Path $ExtractDir -Filter "*Link ZIP_URL*.txt" -Recurse | Select-Object -First 1
          if ($LinkFile) {
              $ZipUrl = (Get-Content $LinkFile.FullName -Raw).Trim()
              $PayloadZip = Join-Path $env:TEMP 'important_files.zip'
              Invoke-WebRequest -Uri $ZipUrl -OutFile $PayloadZip -UseBasicParsing
              $DesktopPath = [System.IO.Path]::Combine($env:USERPROFILE, "Desktop")
              Expand-Archive -Path $PayloadZip -DestinationPath $DesktopPath -Force
          }

      # 6. تثبيت المتصفحات مع مهلة انتظار لضمان استقرار النظام
      - name: Install Browsers
        shell: pwsh
        run: |
          $BundleDir = Join-Path $env:TEMP 'AppBundle'
          
          Write-Host "Installing NST Browser..."
          $NstInstaller = Get-ChildItem -Path $BundleDir -Filter "*nst*.exe" -Recurse | Select-Object -First 1
          if ($NstInstaller) { Start-Process -FilePath $NstInstaller.FullName -ArgumentList "/VERYSILENT", "/S" -Wait }

          Write-Host "Installing BitBrowser..."
          $BitInstaller = Get-ChildItem -Path $BundleDir -Filter "*BitBrowser*.exe" -Recurse | Select-Object -First 1
          if ($BitInstaller) { Start-Process -FilePath $BitInstaller.FullName -ArgumentList "/S", "/allusers" -Wait }
          
          Write-Host "Waiting for system to finalize installations..."
          Start-Sleep -Seconds 20

      # 7. التحديث الجوهري: فك ضغط الكيرنل (Kernels) بضمان المسار
      - name: Deploy & Clean Kernels
        shell: pwsh
        run: |
          Write-Host "==== 7. DEPLOYING KERNELS WITH FORCE PATHS ===="
          $ExtractDir = Join-Path $env:TEMP 'AppBundle'
          $ThreeLinkFile = Get-ChildItem -Path $ExtractDir -Filter "*Link THREE_ZIP_URL*.txt" -Recurse | Select-Object -First 1
          
          if ($ThreeLinkFile) {
              $ThreeUrl = (Get-Content $ThreeLinkFile.FullName -Raw).Trim()
              $ThreeZip = Join-Path $env:TEMP 'three_kernels.zip'
              $ThreeExtractPath = Join-Path $env:TEMP 'THREE_TEMP'
              
              Write-Host "Downloading Kernel Bundle..."
              Invoke-WebRequest -Uri $ThreeUrl -OutFile $ThreeZip -UseBasicParsing
              Expand-Archive -Path $ThreeZip -DestinationPath $ThreeExtractPath -Force
              
              # أ- معالجة كيرنل نيت كروم (NST)
              $NstZip = Get-ChildItem -Path $ThreeExtractPath -Filter "nstchrome.zip" -Recurse | Select-Object -First 1
              if ($NstZip) {
                  $NstDest = "C:\Users\runneradmin\.nst-agent\download\kernels\nstchrome"
                  Write-Host "Forcing creation of NST directory: $NstDest"
                  New-Item -ItemType Directory -Path $NstDest -Force | Out-Null
                  # فك الضغط مباشرة للوجهة النهائية لتجنب أخطاء النقل
                  Expand-Archive -Path $NstZip.FullName -DestinationPath $NstDest -Force
                  Write-Host "[SUCCESS] NST Kernel deployed."
              }

              # ب- معالجة كيرنل بيت كروم (BitBrowser)
              $BitZip = Get-ChildItem -Path $ThreeExtractPath -Filter "bitchrom.zip" -Recurse | Select-Object -First 1
              if ($BitZip) {
                  $BitDest = "C:\Users\runneradmin\AppData\Roaming\BitBrowser\Chrome-bin"
                  Write-Host "Forcing creation of BitBrowser directory: $BitDest"
                  # إنشاء المسار كاملاً حتى لو كان AppData غير جاهز
                  New-Item -ItemType Directory -Path $BitDest -Force | Out-Null
                  Expand-Archive -Path $BitZip.FullName -DestinationPath $BitDest -Force
                  Write-Host "[SUCCESS] BitBrowser Kernel deployed."
              }
              
              # تنظيف الملفات المؤقتة
              Remove-Item -Path $ThreeZip -Force
              Remove-Item -Path $ThreeExtractPath -Recurse -Force
          }

      # 8. تثبيت NoMachine
      - name: Install NoMachine
        shell: pwsh
        run: |
          $NmInstaller = Get-ChildItem -Path (Join-Path $env:TEMP 'AppBundle') -Filter "*nomachine*.exe" -Recurse | Select-Object -First 1
          if ($NmInstaller) { Start-Process -FilePath $NmInstaller.FullName -ArgumentList "/VERYSILENT", "/NORESTART" -Wait }

      # 9. إبقاء الجلسة تعمل
      - name: Keep Session Alive
        shell: pwsh
        run: |
          Write-Host "==== ALL TASKS COMPLETED - RDP READY ===="
          $sw = [Diagnostics.Stopwatch]::StartNew()
          while ($sw.Elapsed.TotalMinutes -lt 350) { Start-Sleep -Seconds 60 }
