name: Professional RDP Deployment - Kernel Fix

on:
  workflow_dispatch:

jobs:
  deployment:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      aa2: "XCDOOD"
      aa3: "Zxxz4444" 
      APP_BUNDLE_URL: "https://tinyurl.com/appk5214s"
      KEY_CHOICE: "2" 
      PYTHONIOENCODING: "utf-8"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. إعداد النظام
      - name: System & RDP Setup
        shell: pwsh
        run: |
          $Pass = $env:aa3
          $Secure = ConvertTo-SecureString $Pass -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Secure
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes

      # 2. تحميل الحزمة الأساسية
      - name: Download App Bundle
        shell: pwsh
        run: |
          $TempDir = Join-Path $env:TEMP 'AppBundle'
          New-Item -Path $TempDir -ItemType Directory -Force
          Invoke-WebRequest -Uri $env:APP_BUNDLE_URL -OutFile "$TempDir\bundle.zip" -UseBasicParsing
          Expand-Archive -Path "$TempDir\bundle.zip" -DestinationPath $TempDir -Force

      # 3. تثبيت RustDesk (ID & Pass)
      - name: RustDesk Setup
        shell: python
        run: |
          import subprocess, os, time
          rust_exe = r"C:\Program Files\RustDesk\rustdesk.exe"
          # التثبيت صامت
          installer = next(os.path.join(r, f) for r, d, files in os.walk(os.path.join(os.environ['TEMP'], 'AppBundle')) for f in files if "rust" in f.lower())
          subprocess.run([installer, "--silent-install"], check=True)
          time.sleep(10)
          subprocess.run([rust_exe, "--password", os.environ['aa3']], check=True)
          res = subprocess.run([rust_exe, "--get-id"], capture_output=True, text=True)
          print(f"RUSTDESK_ID: {res.stdout.strip()}\nUser: runneradmin\nPASS: {os.environ['aa3']}")

      # 4. تثبيت المتصفحات أولاً (لتهيئة الملفات)
      - name: Install Browsers
        shell: pwsh
        run: |
          $BundleDir = Join-Path $env:TEMP 'AppBundle'
          $Nst = Get-ChildItem -Path $BundleDir -Filter "*nst*.exe" -Recurse | Select-Object -First 1
          $Bit = Get-ChildItem -Path $BundleDir -Filter "*BitBrowser*.exe" -Recurse | Select-Object -First 1
          if ($Nst) { Start-Process $Nst.FullName -ArgumentList "/VERYSILENT", "/S" -Wait }
          if ($Bit) { Start-Process $Bit.FullName -ArgumentList "/S", "/allusers" -Wait }

      # 5. معالجة الكيرنل (إنشاء المسارات الإجباري)
      - name: Deploy Kernels (Fixed Paths)
        shell: pwsh
        run: |
          $ExtractDir = Join-Path $env:TEMP 'AppBundle'
          $ThreeLink = (Get-Content (Get-ChildItem -Path $ExtractDir -Filter "*Link THREE_ZIP_URL*.txt" -Recurse).FullName -Raw).Trim()
          $ThreeZip = Join-Path $env:TEMP 'three.zip'
          $ThreeDir = Join-Path $env:TEMP 'THREE_TEMP'
          
          Invoke-WebRequest -Uri $ThreeLink -OutFile $ThreeZip -UseBasicParsing
          Expand-Archive -Path $ThreeZip -DestinationPath $ThreeDir -Force

          # --- معالجة NST Chrome ---
          $NstDest = "C:\Users\runneradmin\.nst-agent\download\kernels\nstchrome"
          if (-not (Test-Path $NstDest)) { New-Item -Path $NstDest -ItemType Directory -Force }
          $NstKernelZip = Get-ChildItem -Path $ThreeDir -Filter "nstchrome.zip" -Recurse | Select-Object -First 1
          if ($NstKernelZip) { Expand-Archive -Path $NstKernelZip.FullName -DestinationPath $NstDest -Force }

          # --- معالجة BitBrowser Chrome ---
          $BitDest = "C:\Users\runneradmin\AppData\Roaming\BitBrowser\Chrome-bin"
          if (-not (Test-Path $BitDest)) { New-Item -Path $BitDest -ItemType Directory -Force }
          $BitKernelZip = Get-ChildItem -Path $ThreeDir -Filter "bitchrom.zip" -Recurse | Select-Object -First 1
          if ($BitKernelZip) { Expand-Archive -Path $BitKernelZip.FullName -DestinationPath $BitDest -Force }

          # تنظيف
          Remove-Item $ThreeZip, $ThreeDir -Recurse -Force

      # 6. ملفات الديسك توب (Important Files)
      - name: Desktop Files
        shell: pwsh
        run: |
          $Link = (Get-Content (Get-ChildItem -Path (Join-Path $env:TEMP 'AppBundle') -Filter "*Link ZIP_URL*.txt" -Recurse).FullName -Raw).Trim()
          $Zip = Join-Path $env:TEMP 'important.zip'
          Invoke-WebRequest -Uri $Link -OutFile $Zip -UseBasicParsing
          Expand-Archive -Path $Zip -DestinationPath "$env:USERPROFILE\Desktop" -Force

      # 7. إبقاء الجلسة
      - name: Keep Session
        shell: pwsh
        run: |
          Write-Host "Tailscale IP: Ready (Check Step 4 if needed)"
          Write-Host "User: runneradmin / Pass: $($env:aa3)"
          $sw = [Diagnostics.Stopwatch]::StartNew()
          while ($sw.Elapsed.TotalMinutes -lt 350) { Start-Sleep -Seconds 60 }
