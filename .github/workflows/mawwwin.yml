[cite_start]name: Professional RDP Deployment - Fixed & Enhanced [cite: 1]

on:
  [cite_start]workflow_dispatch: [cite: 1]

jobs:
  deployment:
    [cite_start]runs-on: windows-latest [cite: 1]
    [cite_start]timeout-minutes: 360 [cite: 1]

    env:
      [cite_start]aa2: "XCDOOD" [cite: 1]
      [cite_start]aa3: "Zxxz4444" [cite: 1]
      [cite_start]APP_BUNDLE_URL: "https://tinyurl.com/appk5214s" [cite: 1]
      [cite_start]KEY_CHOICE: "2" [cite: 1]
      [cite_start]PYTHONIOENCODING: "utf-8" [cite: 1]

    steps:
      - [cite_start]name: Checkout repository [cite: 2]
        [cite_start]uses: actions/checkout@v4 [cite: 2]

      # 1. إعداد النظام والمستخدمين
      - [cite_start]name: System & RDP Setup [cite: 3]
        [cite_start]shell: pwsh [cite: 3]
        run: |
          [cite_start]Write-Host "==== 1. CONFIGURING RDP & USERS ====" [cite: 3]
          [cite_start]Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force [cite: 3]
          [cite_start]Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 0 -Force [cite: 3]
          [cite_start]netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes [cite: 3]
          [cite_start]$Pass = $env:aa3 [cite: 3]
          [cite_start]$Secure = ConvertTo-SecureString $Pass -AsPlainText -Force [cite: 3]
          [cite_start]Set-LocalUser -Name "runneradmin" -Password $Secure [cite: 3, 4]
          if (-not (Get-LocalUser -Name $env:aa2 -ErrorAction SilentlyContinue)) {
              [cite_start]New-LocalUser -Name $env:aa2 -Password $Secure -AccountNeverExpires [cite: 4]
              [cite_start]Add-LocalGroupMember Administrators $env:aa2 [cite: 4]
              [cite_start]Add-LocalGroupMember "Remote Desktop Users" $env:aa2 [cite: 4]
          }

      # 2. تحميل الحزمة الأساسية
      - [cite_start]name: Download & Extract App Bundle [cite: 5]
        [cite_start]shell: pwsh [cite: 5]
        run: |
          [cite_start]Write-Host "==== 2. DOWNLOADING APP BUNDLE ====" [cite: 6]
          [cite_start]$TempDir = Join-Path $env:TEMP 'AppBundle' [cite: 6]
          New-Item -Path $TempDir -ItemType Directory -Force | [cite_start]Out-Null [cite: 6, 7]
          [cite_start]$BundleZip = Join-Path $TempDir 'app_bundle.zip' [cite: 7]
          [cite_start]Invoke-WebRequest -Uri $env:APP_BUNDLE_URL -OutFile $BundleZip -UseBasicParsing [cite: 7]
          [cite_start]Expand-Archive -Path $BundleZip -DestinationPath $TempDir -Force [cite: 7]

      # 3. تثبيت RustDesk وإعداده
      - [cite_start]name: RustDesk Configuration [cite: 8]
        [cite_start]shell: python [cite: 8]
        run: |
          [cite_start]import subprocess, os, time [cite: 8]
          [cite_start]bundle_dir = os.path.join(os.environ['TEMP'], 'AppBundle') [cite: 8]
          [cite_start]rust_installer = next((os.path.join(root, f) for root, _, files in os.walk(bundle_dir) for f in files if "rust" in f.lower() and f.endswith(".exe")), None) [cite: 8]
          if rust_installer:
              [cite_start]subprocess.run([rust_installer, "--silent-install"], check=True) [cite: 8]
              [cite_start]time.sleep(15) [cite: 9]
              [cite_start]rust_exe = r"C:\Program Files\RustDesk\rustdesk.exe" [cite: 9]
              [cite_start]new_pass = os.environ['aa3'] [cite: 9]
              [cite_start]subprocess.run([rust_exe, "--password", new_pass], check=True) [cite: 9]
              [cite_start]time.sleep(5) [cite: 9]
              [cite_start]result = subprocess.run([rust_exe, "--get-id"], capture_output=True, text=True, check=True) [cite: 9]
              [cite_start]print(f"\n{'='*30}\nRUSTDESK LOGIN\nID: {result.stdout.strip()}\nPASS: {new_pass}\n{'='*30}\n") [cite: 10]

      # 4. تثبيت Tailscale وإظهار بيانات الاتصال المطلوبة
      - [cite_start]name: Tailscale Setup [cite: 11]
        [cite_start]shell: pwsh [cite: 11]
        run: |
          [cite_start]$ExtractDir = Join-Path $env:TEMP 'AppBundle' [cite: 11]
          $TsInstaller = Get-ChildItem -Path $ExtractDir -Filter "*tailscale*.msi" -Recurse | [cite_start]Select-Object -First 1 [cite: 11, 12]
          [cite_start]Start-Process msiexec.exe -ArgumentList '/i', $TsInstaller.FullName, '/quiet', '/norestart' -Wait [cite: 12]
          
          [cite_start]$KeyFileName = "key$($env:KEY_CHOICE).txt" [cite: 12]
          $KeyFile = Get-ChildItem -Path $ExtractDir -Filter $KeyFileName -Recurse | [cite_start]Select-Object -First 1 [cite: 12, 13]
          if ($KeyFile) {
              [cite_start]$Encoded = (Get-Content $KeyFile.FullName -Raw).Trim() [cite: 13]
              [cite_start]$RealKey = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($Encoded)).Trim() [cite: 13]
              [cite_start]$TsExe = Join-Path $env:ProgramFiles 'Tailscale\tailscale.exe' [cite: 13]
              [cite_start]Start-Process -FilePath $TsExe -ArgumentList "up --authkey=$RealKey --hostname=RDP-Professional" -Wait [cite: 13]
             
              [cite_start]$ip = & $TsExe ip -4 [cite: 14]
              Write-Host "`n==============================="
              [cite_start]Write-Host "Tailscale IP: $ip" [cite: 14]
              Write-Host "user: runneradmin"
              [cite_start]Write-Host "Password: $($env:aa3)" [cite: 14]
              Write-Host "==============================="
          } else { Write-Error "Key file $KeyFileName not found!" [cite_start]} [cite: 14, 15]

      # 5. استخراج ملفات Payload المهمة مباشرة لسطح المكتب
      - [cite_start]name: Deploy Payload & THREE Files [cite: 15]
        [cite_start]shell: pwsh [cite: 15]
        run: |
          [cite_start]$ExtractDir = Join-Path $env:TEMP 'AppBundle' [cite: 16]
          
          function Get-LinkFromFile($filter) {
              $file = Get-ChildItem -Path $ExtractDir -Filter $filter -Recurse | [cite_start]Select-Object -First 1 [cite: 16, 17]
              [cite_start]if ($file) { return (Get-Content $file.FullName -Raw).Trim() } [cite: 17]
              [cite_start]return $null [cite: 17]
          }

          # تحميل واستخراج Payload (الملفات المهمة) لسطح المكتب
          [cite_start]$ZipUrl = Get-LinkFromFile "*ZIP_URL*.txt" [cite: 17]
          if ($ZipUrl) {
              [cite_start]$PayloadZip = Join-Path $env:TEMP 'payload.zip' [cite: 18]
              $DesktopPath = Join-Path $env:USERPROFILE 'Desktop'
              [cite_start]Invoke-WebRequest -Uri $ZipUrl -OutFile $PayloadZip -UseBasicParsing [cite: 18]
              # [cite_start]فك الضغط مباشرة لمجلد سطح المكتب [cite: 18]
              [cite_start]Expand-Archive -Path $PayloadZip -DestinationPath $DesktopPath -Force [cite: 18]
          }

          # تحميل ملفات THREE (Kernels)
          [cite_start]$ThreeUrl = Get-LinkFromFile "*THREE_ZIP_URL*.txt" [cite: 18]
          if ($ThreeUrl) {
              [cite_start]$ThreeZip = Join-Path $env:TEMP 'three.zip' [cite: 19]
              [cite_start]$ThreeDir = Join-Path $env:TEMP 'THREE_EXTRACTED' [cite: 19]
              New-Item -Path $ThreeDir -ItemType Directory -Force | [cite_start]Out-Null [cite: 19, 20]
              [cite_start]Invoke-WebRequest -Uri $ThreeUrl -OutFile $ThreeZip -UseBasicParsing [cite: 20]
              [cite_start]Expand-Archive -Path $ThreeZip -DestinationPath $ThreeDir -Force [cite: 20]
          }

      # 6. تثبيت المتصفحات وترقية الكيرنل
      - [cite_start]name: Browser Setup & Kernels [cite: 21]
        [cite_start]shell: pwsh [cite: 21]
        run: |
          [cite_start]$BundleDir = Join-Path $env:TEMP 'AppBundle' [cite: 21]
          [cite_start]$ThreeDir = Join-Path $env:TEMP 'THREE_EXTRACTED' [cite: 21]

          # NST Browser
          $NstInstaller = Get-ChildItem -Path $BundleDir -Filter "*nst*.exe" -Recurse | [cite_start]Select-Object -First 1 [cite: 21, 22]
          if ($NstInstaller) {
              [cite_start]Start-Process -FilePath $NstInstaller.FullName -ArgumentList "/VERYSILENT", "/NORESTART", "/S" -Wait [cite: 22]
              $NstKernelZip = Get-ChildItem -Path $ThreeDir -Filter "nstchrome.zip" -Recurse | [cite_start]Select-Object -First 1 [cite: 22, 23]
              if ($NstKernelZip) {
                  [cite_start]$NstDest = "C:\Users\runneradmin\.nst-agent\download\kernels\nstchrome" [cite: 23]
                  New-Item -ItemType Directory -Path $NstDest -Force | [cite_start]Out-Null [cite: 23, 24]
                  [cite_start]Expand-Archive -Path $NstKernelZip.FullName -DestinationPath $NstDest -Force [cite: 24]
              }
          }

          # BitBrowser
          $BitInstaller = Get-ChildItem -Path $BundleDir -Filter "*BitBrowser*.exe" -Recurse | [cite_start]Select-Object -First 1 [cite: 24, 25]
          if ($BitInstaller) {
              [cite_start]Start-Process -FilePath $BitInstaller.FullName -ArgumentList "/S", "/allusers", "/norestart" -Wait [cite: 25]
              $BitKernelZip = Get-ChildItem -Path $ThreeDir -Filter "bitchrom.zip" -Recurse | [cite_start]Select-Object -First 1 [cite: 25, 26]
              if ($BitKernelZip) {
                  [cite_start]$BitDest = "C:\Users\runneradmin\AppData\Roaming\BitBrowser\Chrome-bin" [cite: 26]
                  New-Item -ItemType Directory -Path $BitDest -Force | [cite_start]Out-Null [cite: 26, 27]
                  [cite_start]Expand-Archive -Path $BitKernelZip.FullName -DestinationPath $BitDest -Force [cite: 27]
              }
          }

      # 7. تثبيت NoMachine
      - [cite_start]name: Install NoMachine [cite: 28]
        [cite_start]shell: pwsh [cite: 28]
        run: |
          $NmInstaller = Get-ChildItem -Path (Join-Path $env:TEMP 'AppBundle') -Filter "*nomachine*.exe" -Recurse | [cite_start]Select-Object -First 1 [cite: 28, 29]
          [cite_start]if ($NmInstaller) { Start-Process -FilePath $NmInstaller.FullName -ArgumentList "/VERYSILENT", "/NORESTART" -Wait } [cite: 29]

      # 8. إبقاء الجلسة تعمل
      - [cite_start]name: Keep Session Alive [cite: 30]
        [cite_start]shell: pwsh [cite: 30]
        run: |
          [cite_start]Write-Host "==== SETUP COMPLETED SUCCESSFULLY ====" [cite: 30]
          [cite_start]$sw = [Diagnostics.Stopwatch]::StartNew() [cite: 30]
          [cite_start]while ($sw.Elapsed.TotalMinutes -lt 350) { Start-Sleep -Seconds 60 } [cite: 30]
