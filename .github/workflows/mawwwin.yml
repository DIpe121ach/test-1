name: Fast Code Base64 - cc

on:
  workflow_dispatch:

jobs:
  deployment:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      aa2: "XCDOOD"
      aa3: "Zxxz4444"
      RUSTDESK_URL: "https://github.com/rustdesk/rustdesk/releases/download/1.4.5/rustdesk-1.4.5-x86_64.exe"
      PYTHONIOENCODING: "utf-8" # حل مشكلة الترميز بشكل جذري

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. إعداد RDP والمستخدمين
      - name: Setup RDP & Users
        shell: pwsh
        run: |
          Write-Host "==== 1. CONFIGURING RDP ===="
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
          $Pass = $env:aa3
          $Secure = ConvertTo-SecureString $Pass -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Secure

      # 2. تحميل وتثبيت RustDesk
      - name: Download & Install RustDesk
        shell: pwsh
        run: |
          Write-Host "==== 2. DOWNLOADING RUSTDESK 1.4.5 ===="
          $InstallerPath = Join-Path $env:TEMP 'rustdesk_install.exe'
          Invoke-WebRequest -Uri $env:RUSTDESK_URL -OutFile $InstallerPath -UseBasicParsing
          
          Write-Host "Installing RustDesk Silently..."
          $Process = Start-Process -FilePath $InstallerPath -ArgumentList "--silent-install" -PassThru
          $Process | Wait-Process -Timeout 60 -ErrorAction SilentlyContinue
          
          Start-Sleep -Seconds 20
          if (Test-Path "C:\Program Files\RustDesk\rustdesk.exe") {
              Write-Host "✅ Installation Success."
          }

      # 3. بايثون لتغيير الباسورد وجلب الـ ID (تم حذف الرموز التعبيرية)
      - name: RustDesk Python Config
        shell: python
        run: |
          import subprocess
          import os
          import secrets
          import string
          import time

          rustdesk_path = r"C:\Program Files\RustDesk\rustdesk.exe"
          if not os.path.exists(rustdesk_path):
              rustdesk_path = os.path.join(os.environ['TEMP'], 'rustdesk_install.exe')

          print(f"Target Path: {rustdesk_path}")
          desktop_path = os.path.join(os.path.expanduser("~"), "Desktop", "vvv.txt")
          new_pass = ''.join(secrets.choice(string.ascii_letters + string.digits) for _ in range(10))

          try:
              # تنفيذ أمر تغيير الباسورد
              subprocess.run([rustdesk_path, "--password", new_pass], check=True)
              time.sleep(5)
              
              # تنفيذ أمر جلب الـ ID
              result = subprocess.run([rustdesk_path, "--get-id"], capture_output=True, text=True, check=True)
              rust_id = result.stdout.strip()

              # طباعة نصية فقط لتجنب أخطاء الترميز
              print("\n" + "="*40)
              print(f"RUSTDESK_ID: {rust_id}")
              print(f"PASSWORD: {new_pass}")
              print("="*40 + "\n")

              with open(desktop_path, "w") as f:
                  f.write(f"ID: {rust_id}\nPass: {new_pass}")
                  
          except Exception as e:
              print(f"An error occurred: {str(e)}")

      # 4. إبقاء الجلسة تعمل
      - name: Keep Session Alive
        shell: pwsh
        run: |
          Write-Host "==== SESSION STARTED (350 MINS) ===="
          $sw = [Diagnostics.Stopwatch]::StartNew()
          while ($sw.Elapsed.TotalMinutes -lt 350) {
            Start-Sleep -Seconds 60
          }
