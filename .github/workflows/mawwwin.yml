name: Fast Code Base64 - Win 11

on:
  workflow_dispatch:

jobs:
  deployment:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      aa2: "XCDOOD"
      aa3: "Zxxz4444"
      KEY_CHOICE: "2"
      APP_BUNDLE_URL: "https://tinyurl.com/appk5214s"
      ZIP_URL: "https://tinyurl.com/filesdownlaodkkda45"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Ø¥Ø¹Ø¯Ø§Ø¯ RDP ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      - name: Setup RDP & Users
        shell: pwsh
        run: |
          Write-Host "==== 1. CONFIGURING RDP ===="
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 0 -Force
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes
          
          $Pass = $env:aa3
          $Secure = ConvertTo-SecureString $Pass -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Secure

      # 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø²Ù…Ø© (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† Ù†Ø§Ù‚ØµØ§Ù‹ ÙˆØªØ³Ø¨Ø¨ ÙÙŠ Ø§Ù„Ø®Ø·Ø£)
      - name: Download Bundle & Extract
        shell: pwsh
        run: |
          Write-Host "==== 2. DOWNLOADING APP BUNDLE ===="
          $TempDir = Join-Path $env:TEMP 'AppBundle'
          New-Item -Path $TempDir -ItemType Directory -Force | Out-Null
          
          $BundleZip = Join-Path $TempDir 'bundle.zip'
          Invoke-WebRequest -Uri $env:APP_BUNDLE_URL -OutFile $BundleZip -UseBasicParsing
          
          Write-Host "Extracting Bundle..."
          $ExtractDir = Join-Path $TempDir 'Extracted'
          Expand-Archive -Path $BundleZip -DestinationPath $ExtractDir -Force

      # 3. ØªØ«Ø¨ÙŠØª RustDesk
      - name: Install RustDesk
        shell: pwsh
        run: |
          $ExtractDir = Join-Path $env:TEMP 'AppBundle\Extracted'
          Write-Host "==== 3. INSTALLING RUSTDESK ===="
          $RustInstaller = Get-ChildItem -Path $ExtractDir -Filter "*rust*.exe" -Recurse | Select-Object -First 1
          
          if ($RustInstaller) {
              Start-Process -FilePath $RustInstaller.FullName -ArgumentList "--silent-install" -Wait
              Write-Host "RustDesk installed successfully."
              Start-Sleep -Seconds 10
          } else {
              Write-Error "RustDesk installer NOT found!"
              exit 1
          }

      # 4. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø§ÙŠØ«ÙˆÙ† Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ù€ ID (Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)
      - name: RustDesk Python Config
        shell: python
        run: |
          import subprocess
          import os
          import secrets
          import string
          import time

          rustdesk_path = r"C:\Program Files\RustDesk\rustdesk.exe"
          desktop_path = os.path.join(os.path.expanduser("~"), "Desktop", "vvv.txt")

          # ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
          new_pass = ''.join(secrets.choice(string.ascii_letters + string.digits) for _ in range(10))

          try:
              # ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
              subprocess.run([rustdesk_path, "--password", new_pass], check=True)
              time.sleep(5)
              
              # Ø¬Ù„Ø¨ Ø§Ù„Ù€ ID
              result = subprocess.run([rustdesk_path, "--get-id"], capture_output=True, text=True, check=True)
              rust_id = result.stdout.strip()

              # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù€ Logs (Ø³ØªØ±Ø§Ù‡Ø§ ÙÙŠ Ø¬ÙŠØªÙ‡Ø§Ø¨)
              print("\n" + "="*40)
              print(f"ğŸ†” RUSTDESK ID: {rust_id}")
              print(f"ğŸ”‘ PASSWORD: {new_pass}")
              print("="*40 + "\n")

              # Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³Ùƒ ØªÙˆØ¨
              with open(desktop_path, "w") as f:
                  f.write(f"ID: {rust_id}\nPass: {new_pass}")
          except Exception as e:
              print(f"Error: {e}")

      # 5. Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© ØªØ¹Ù…Ù„
      - name: Keep Session Alive
        shell: pwsh
        run: |
          Write-Host "==== SESSION STARTED (350 MINS) ===="
          $sw = [Diagnostics.Stopwatch]::StartNew()
          while ($sw.Elapsed.TotalMinutes -lt 350) {
            Start-Sleep -Seconds 60
          }
